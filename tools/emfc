#!/usr/bin/env bash
set -eu

DIR=${LLVM_BUILD_DIR}
BBC=${DIR}/bin/bbc
TCO=${DIR}/bin/tco

ARGS=()

while [[ $# -gt 0 ]]; do
    case $1 in
        -o)
            OUT="$2"
            shift 2
            ;;
        -c)
            NO_LINKING=true
            shift
            ;;
        -*|--*)
            echo "Unknown argument $1"
            exit 1
            ;;
        *)
            ARGS+=("$1")
            shift
            ;;
    esac
done

set -- "${ARGS[@]}"

IN=$1
IN_BASE="${IN%.*}"

OUT=${OUT-${IN_BASE}.o}
OUT_BASE="${OUT%.*}"

${BBC} "$IN" -o - | \
    ${TCO} --external-name-interop | \
    ${TCO} --target=wasm32-unknown-emscripten > \
    "${OUT_BASE}.ll"

# Replace dots in symbols of link-once constants by underscore to
# avoid syntax errors in the .js glue generated by Emscripten
sed -i "" "s/_QQcl\./_QQcl_/g" ${OUT_BASE}.ll

if [ -z ${NO_LINKING-} ]
then
    llc -march=wasm32 -filetype=obj --relocation-model=pic "${OUT_BASE}.ll" -o "${OUT_BASE}.s"
    wasm-ld "${OUT_BASE}.s" -o "${OUT}" --no-entry --allow-undefined --relocatable --experimental-pic
else
    llc -march=wasm32 -filetype=obj --relocation-model=pic "${OUT_BASE}.ll" -o "${OUT}"
fi
